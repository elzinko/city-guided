name: Render manual deploy

on:
  workflow_dispatch:
    inputs:
      deploy_service:
        description: 'Service to deploy (frontend or api)'
        required: true
        default: 'frontend'

concurrency:
  group: render-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.get_sha.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit SHA
        id: get_sha
        run: echo "sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable corepack and install
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build --filter apps-web-frontend...

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: apps/web-frontend/.next

  build-api:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.get_sha.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit SHA
        id: get_sha
        run: echo "sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable corepack and install
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: Build API
        run: pnpm run build --filter services-api...

      - name: Upload api dist
        uses: actions/upload-artifact@v4
        with:
          name: api-dist
          path: services/api/dist

  deploy-to-render:
    if: github.event_name == 'workflow_dispatch'
    needs: [build-frontend, build-api]
    runs-on: ubuntu-latest
    env:
      RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
      RENDER_FRONTEND_SERVICE_ID: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
      RENDER_API_SERVICE_ID: ${{ secrets.RENDER_API_SERVICE_ID }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Determine commit
        id: commit
        run: |
          echo "commit=${{ needs.build-frontend.outputs.commit_sha }}" >> $GITHUB_OUTPUT

      - name: Get existing env var id (if any)
        id: get_env
        run: |
          SERVICE=${{ env.RENDER_FRONTEND_SERVICE_ID }}
          TOKEN=${{ env.RENDER_API_KEY }}
          curl -s -H "Authorization: Bearer $TOKEN" "https://api.render.com/v1/services/$SERVICE/env-vars" | jq -r '.[] | select(.key=="NEXT_PUBLIC_RENDER_DEPLOYED_COMMIT") | .id' | tr -d '\n' > env_id || true
          if [ -s env_id ]; then echo "env_id=$(cat env_id)" >> $GITHUB_OUTPUT; else echo "env_id=" >> $GITHUB_OUTPUT; fi

      - name: Create or update NEXT_PUBLIC_RENDER_DEPLOYED_COMMIT
        run: |
          SERVICE=${{ env.RENDER_FRONTEND_SERVICE_ID }}
          TOKEN=${{ env.RENDER_API_KEY }}
          SHA=${{ needs.build-frontend.outputs.commit_sha }}
          if [ -n "${{ steps.get_env.outputs.env_id }}" ]; then
            ENV_ID=${{ steps.get_env.outputs.env_id }}
            echo "Patching env var $ENV_ID to $SHA"
            curl -s -X PATCH "https://api.render.com/v1/env-vars/$ENV_ID" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"value\": \"$SHA\"}" | jq .
          else
            echo "Creating env var NEXT_PUBLIC_RENDER_DEPLOYED_COMMIT=$SHA"
            curl -s -X POST "https://api.render.com/v1/services/$SERVICE/env-vars" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"key\": \"NEXT_PUBLIC_RENDER_DEPLOYED_COMMIT\", \"value\": \"$SHA\", \"sensitive\": false}" | jq .
          fi

      - name: Trigger a deploy on Render (frontend)
        id: trigger_frontend
        run: |
          SERVICE=${{ env.RENDER_FRONTEND_SERVICE_ID }}
          TOKEN=${{ env.RENDER_API_KEY }}
          SHA=${{ needs.build-frontend.outputs.commit_sha }}
          echo "Triggering deploy for commit $SHA"
          RESP=$(curl -s -X POST "https://api.render.com/v1/services/$SERVICE/deploys" -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d "{\"commit\": \"$SHA\"}")
          echo "$RESP" | jq .
          echo "deploy_id=$(echo $RESP | jq -r .id)" >> $GITHUB_OUTPUT

      - name: Trigger a deploy on Render (api)
        id: trigger_api
        run: |
          SERVICE=${{ env.RENDER_API_SERVICE_ID }}
          TOKEN=${{ env.RENDER_API_KEY }}
          SHA=${{ needs.build-api.outputs.commit_sha }}
          echo "Triggering deploy for commit $SHA"
          RESP=$(curl -s -X POST "https://api.render.com/v1/services/$SERVICE/deploys" -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d "{\"commit\": \"$SHA\"}")
          echo "$RESP" | jq .
          echo "deploy_id=$(echo $RESP | jq -r .id)" >> $GITHUB_OUTPUT

      - name: Wait for deploy completion (frontend)
        run: |
          TOKEN=${{ env.RENDER_API_KEY }}
          DEPLOY_ID=${{ steps.trigger_frontend.outputs.deploy_id }}
          echo "Waiting for deploy $DEPLOY_ID"
          for i in {1..60}; do
            STATUS=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.render.com/v1/deploys/$DEPLOY_ID" | jq -r .status)
            echo "status=$STATUS"
            if [ "$STATUS" = "success" ]; then echo "Deploy succeeded"; exit 0; fi
            if [ "$STATUS" = "failed" ]; then echo "Deploy failed"; exit 1; fi
            sleep 5
          done
          echo "Timeout waiting for deploy"; exit 1

      - name: Wait for deploy completion (api)
        run: |
          TOKEN=${{ env.RENDER_API_KEY }}
          DEPLOY_ID=${{ steps.trigger_api.outputs.deploy_id }}
          echo "Waiting for deploy $DEPLOY_ID"
          for i in {1..60}; do
            STATUS=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.render.com/v1/deploys/$DEPLOY_ID" | jq -r .status)
            echo "status=$STATUS"
            if [ "$STATUS" = "success" ]; then echo "Deploy succeeded"; exit 0; fi
            if [ "$STATUS" = "failed" ]; then echo "Deploy failed"; exit 1; fi
            sleep 5
          done
          echo "Timeout waiting for deploy"; exit 1

      - name: Output deployed commit
        run: echo "Deployed commit: frontend=${{ needs.build-frontend.outputs.commit_sha }} api=${{ needs.build-api.outputs.commit_sha }}"
