#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-commit hook: quick local CI
# Steps: if node_modules seems missing, run `pnpm -w install` once, then run build and tests and finally lint.
# Stop the commit if any step fails.

# Skip E2E tests by default (they take too long)
# To enable E2E tests: unset SKIP_E2E or set it to empty
export SKIP_E2E=1

# quick check: is pnpm available?
if ! command -v pnpm >/dev/null 2>&1; then
  echo "pnpm not found. Please install pnpm or enable corepack (corepack enable; corepack prepare pnpm@8 --activate)."
  exit 1
fi

# Check if lockfile is up to date (especially important for workspace changes)
echo "Checking if lockfile is up to date..."
pnpm install --frozen-lockfile >/dev/null 2>&1
RC=$?
if [ $RC -ne 0 ]; then
  echo "⚠️  pnpm-lock.yaml is outdated or dependencies have changed."
  echo "   Running 'pnpm install' to update lockfile..."
  pnpm install
  RC=$?
  if [ $RC -ne 0 ]; then
    echo "❌ pnpm install failed (exit $RC). Aborting commit."
    exit $RC
  fi
  echo "✅ Lockfile updated. Please review and stage pnpm-lock.yaml if needed."
  # Auto-stage the lockfile if it changed
  if git diff --quiet pnpm-lock.yaml 2>/dev/null; then
    echo "   (lockfile unchanged)"
  else
    echo "   Staging updated pnpm-lock.yaml..."
    git add pnpm-lock.yaml
  fi
fi

# If top-level node_modules missing, run install (this keeps the hook idempotent and avoids forcing network installs every commit)
if [ ! -d "node_modules" ]; then
  echo "node_modules missing: running 'pnpm install'..."
  pnpm install
  RC=$?
  if [ $RC -ne 0 ]; then
    echo "❌ pnpm install failed (exit $RC). Aborting commit."
    exit $RC
  fi
fi

echo "Building npm packages (.lifefindsaway and .iamthelaw)..."
# Build lifefindsaway
if [ -d ".lifefindsaway" ]; then
  cd .lifefindsaway
  pnpm install --ignore-workspace >/dev/null 2>&1
  pnpm build
  RC=$?
  cd ..
  if [ $RC -ne 0 ]; then
    echo "❌ .lifefindsaway build failed (exit $RC). Aborting commit."
    exit $RC
  fi
  echo "✅ .lifefindsaway built successfully"
fi

# Build iamthelaw
if [ -d ".iamthelaw" ]; then
  cd .iamthelaw
  pnpm install --ignore-workspace >/dev/null 2>&1
  pnpm build
  RC=$?
  cd ..
  if [ $RC -ne 0 ]; then
    echo "❌ .iamthelaw build failed (exit $RC). Aborting commit."
    exit $RC
  fi
  echo "✅ .iamthelaw built successfully"
fi

echo "Running build (quick check)..."
pnpm -w build
RC=$?
if [ $RC -ne 0 ]; then
  echo "Build failed (exit $RC). Aborting commit."
  exit $RC
fi

echo "Running tests..."
pnpm -w test
RC=$?
if [ $RC -ne 0 ]; then
  echo "Tests failed (exit $RC). Aborting commit."
  exit $RC
fi

echo "Running type-check..."
pnpm -w type-check
RC=$?
if [ $RC -ne 0 ]; then
  echo "Type-check failed (exit $RC). Aborting commit."
  exit $RC
fi

echo "Running lint..."
pnpm -w lint
RC=$?
if [ $RC -ne 0 ]; then
  echo "Lint failed (exit $RC). Aborting commit."
  exit $RC
fi

# E2E tests (optional - won't block commit if they fail, but will warn)
# Skip if SKIP_E2E env var is set
if [ -z "$SKIP_E2E" ]; then
  echo ""
  echo "Running E2E tests (optional - warnings only, won't block commit)..."
  
  # Check if Playwright package is installed
  if [ ! -d "apps/web-frontend/node_modules/@playwright/test" ]; then
    echo "⚠️  Playwright not installed. Skipping E2E tests."
    echo "   Install with: cd apps/web-frontend && pnpm exec playwright install chromium"
    echo "   To skip this warning: SKIP_E2E=1 git commit"
  else
    # Check if server is running on port 3080
    SERVER_RUNNING=false
    if command -v curl >/dev/null 2>&1; then
      if curl -sf --connect-timeout 2 http://localhost:3080 >/dev/null 2>&1; then
        SERVER_RUNNING=true
      fi
    elif command -v wget >/dev/null 2>&1; then
      if wget -q --spider --timeout=2 http://localhost:3080 >/dev/null 2>&1; then
        SERVER_RUNNING=true
      fi
    fi
    
    if [ "$SERVER_RUNNING" = "false" ]; then
      echo "⚠️  Frontend server not detected on http://localhost:3080"
      echo "   E2E tests require the server to be running."
      echo "   Start server: pnpm dev (in another terminal)"
      echo "   Or skip E2E tests: SKIP_E2E=1 git commit"
      echo "   Note: Tests can auto-start the server, but it's faster if it's already running"
    else
      echo "✅ Frontend server detected on http://localhost:3080"
    fi
    
    # Try to run E2E tests with a timeout to avoid blocking commits too long
    # Use timeout command if available (GNU coreutils or macOS gtimeout)
    if command -v timeout >/dev/null 2>&1 || command -v gtimeout >/dev/null 2>&1; then
      TIMEOUT_CMD=$(command -v timeout || command -v gtimeout)
      $TIMEOUT_CMD 90 pnpm -w test:e2e 2>&1 | head -50 || {
        echo ""
        echo "⚠️  E2E tests failed or timed out, but commit will proceed."
        echo "   Troubleshooting:"
        echo "   - Ensure server is running: pnpm dev"
        echo "   - Install browsers: cd apps/web-frontend && pnpm exec playwright install chromium"
        echo "   - To skip E2E tests: SKIP_E2E=1 git commit"
      }
    else
      # No timeout command available, run without timeout but limit output
      pnpm -w test:e2e 2>&1 | head -50 || {
        echo ""
        echo "⚠️  E2E tests failed, but commit will proceed."
        echo "   Troubleshooting:"
        echo "   - Ensure server is running: pnpm dev"
        echo "   - Install browsers: cd apps/web-frontend && pnpm exec playwright install chromium"
        echo "   - To skip E2E tests: SKIP_E2E=1 git commit"
      }
    fi
  fi
else
  echo "Skipping E2E tests (SKIP_E2E is set)"
fi

echo "Pre-commit quick CI checks passed."