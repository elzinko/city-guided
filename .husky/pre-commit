#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-commit hook: quick local CI
# Steps: if node_modules seems missing, run `pnpm -w install` once, then run build and tests and finally lint.
# Stop the commit if any step fails.

# quick check: is pnpm available?
if ! command -v pnpm >/dev/null 2>&1; then
  echo "pnpm not found. Please install pnpm or enable corepack (corepack enable; corepack prepare pnpm@8 --activate)."
  exit 1
fi

# If top-level node_modules missing, run install (this keeps the hook idempotent and avoids forcing network installs every commit)
if [ ! -d "node_modules" ]; then
  echo "node_modules missing: running 'pnpm -w install'..."
  pnpm -w install
  RC=$?
  if [ $RC -ne 0 ]; then
    echo "pnpm install failed (exit $RC). Aborting commit."
    exit $RC
  fi
fi

echo "Running build (quick check)..."
pnpm -w build
RC=$?
if [ $RC -ne 0 ]; then
  echo "Build failed (exit $RC). Aborting commit."
  exit $RC
fi

echo "Running tests..."
pnpm -w test
RC=$?
if [ $RC -ne 0 ]; then
  echo "Tests failed (exit $RC). Aborting commit."
  exit $RC
fi

echo "Running lint..."
pnpm -w lint
RC=$?
if [ $RC -ne 0 ]; then
  echo "Lint failed (exit $RC). Aborting commit."
  exit $RC
fi

# E2E tests (optional - won't block commit if they fail, but will warn)
# Skip if SKIP_E2E env var is set
if [ -z "$SKIP_E2E" ]; then
  echo "Running E2E tests (optional - warnings only, won't block commit)..."
  # Check if Playwright package is installed (browsers might not be, but that's OK - test will fail gracefully)
  if [ -d "apps/web-frontend/node_modules/@playwright/test" ]; then
    # Try to run E2E tests with a timeout to avoid blocking commits too long
    # Use timeout command if available (GNU coreutils or macOS gtimeout)
    # Note: Tests require frontend server to be running (pnpm dev in another terminal)
    if command -v timeout >/dev/null 2>&1 || command -v gtimeout >/dev/null 2>&1; then
      TIMEOUT_CMD=$(command -v timeout || command -v gtimeout)
      $TIMEOUT_CMD 90 pnpm -w test:e2e 2>&1 | head -50 || {
        echo "⚠️  E2E tests failed or timed out, but commit will proceed."
        echo "   Note: E2E tests require frontend server running (pnpm dev) and Playwright browsers installed"
        echo "   Install browsers: cd apps/web-frontend && pnpm exec playwright install chromium"
        echo "   To skip E2E tests: SKIP_E2E=1 git commit"
      }
    else
      # No timeout command available, run without timeout but limit output
      pnpm -w test:e2e 2>&1 | head -50 || {
        echo "⚠️  E2E tests failed, but commit will proceed."
        echo "   To skip E2E tests: SKIP_E2E=1 git commit"
      }
    fi
  else
    echo "⚠️  Playwright not installed. Skipping E2E tests."
    echo "   Install with: cd apps/web-frontend && pnpm exec playwright install chromium"
    echo "   To skip this warning: SKIP_E2E=1 git commit"
  fi
else
  echo "Skipping E2E tests (SKIP_E2E is set)"
fi

echo "Pre-commit quick CI checks passed."