name: ci-cd
version: "1.0.0"
description: CI/CD workflow and debugging rules
tags: [ci, cd, debugging, github-actions]

rules:
  - id: investigate-failures
    title: Investigate CI Build Failures
    level: MUST
    content: |
      When a CI build fails:
      - MUST use GitHub MCP to examine logs and failure details
      - MUST attempt to reproduce the problem LOCALLY first using npm/pnpm commands from package.json files (root and sub-folders)
      - MUST use the same commands executed in CI to ensure reproducibility
      - DO NOT rerun CI build without attempting local reproduction, unless the problem is clearly CI-environment specific only
      - SHOULD document differences between local and CI environment if problem cannot be reproduced locally

  - id: local-reproduction
    title: Local Reproduction Commands
    level: MUST
    content: |
      - MUST consult root package.json to identify available scripts
      - MUST consult package.json in sub-folders (apps, services, packages) for specific commands
      - MUST use npm/pnpm scripts defined in these files rather than executing underlying commands directly
      - SHOULD check CI workflow (.github/workflows/*.yml) to understand exactly which commands are executed

  - id: fix-workflow
    title: CI Fix Workflow
    level: SHOULD
    content: |
      1. Investigation: Use GitHub MCP to examine failure logs
      2. Local reproduction: Attempt to reproduce with project npm/pnpm scripts
      3. Fix: Apply the correction
      4. Local validation: Verify problem is resolved locally
      5. Push: Push changes and verify CI passes

  - id: ci-coverage
    title: CI Coverage Requirements
    level: MUST
    content: |
      CI MUST cover at minimum:
      - Lint
      - Build
      - Unit tests
      - Type-check (if typed language)

  - id: smoke-tests
    title: Smoke Tests in CI
    level: SHOULD
    content: |
      CI SHOULD execute a smoke/startup test (proof that "it boots"):
      - Start the application (docker or dev mode)
      - Wait for availability (healthchecks)
      - Verify some essential endpoints
      
      E2E tests MAY be executed:
      - In the same job after build + startup, OR
      - In a separate job (if duration/cost is higher)

  - id: artifact-strategy
    title: Build Artifact Strategy
    level: SHOULD
    content: |
      If images are built, strategy SHOULD support:
      - Immutable tag (commit SHA)
      - Optionally a "latest" tag (or equivalent)
      - Deployment path that REUSES these artifacts (no rebuild on target, unless explicit choice)
