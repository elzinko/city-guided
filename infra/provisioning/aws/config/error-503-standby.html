<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service en veille - CityGuided</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;color:#fff}
    .container{max-width:600px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:20px;padding:40px;text-align:center;box-shadow:0 8px 32px 0 rgba(31,38,135,0.37);border:1px solid rgba(255,255,255,0.18)}
    .icon{width:100px;height:100px;margin:0 auto 30px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:0.8}}
    h1{font-size:28px;font-weight:700;margin-bottom:20px}
    p{font-size:16px;line-height:1.6;margin-bottom:15px;color:rgba(255,255,255,0.9)}
    .info-box{background:rgba(255,255,255,0.15);border-radius:12px;padding:20px;margin:25px 0;border-left:4px solid rgba(255,255,255,0.5)}
    .info-box p{font-size:14px;margin-bottom:0}
    .spinner{margin:20px auto 0;width:40px;height:40px;border:3px solid rgba(255,255,255,0.3);border-top:3px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .status-text{font-size:14px;color:rgba(255,255,255,0.8);margin-top:15px;min-height:20px}
    .footer{margin-top:30px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.2);font-size:12px;color:rgba(255,255,255,0.7)}
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">üåô</div>
    <h1>R√©veil du service...</h1>
    <p>Pour √©conomiser les ressources, notre service se met en veille apr√®s <strong>5 minutes d'inactivit√©</strong>.</p>
    <div class="info-box">
      <p><strong>‚è±Ô∏è Temps de d√©marrage : 30-60 secondes</strong></p>
      <p>Le service red√©marre automatiquement. Patientez quelques instants.</p>
    </div>
    <div class="spinner" id="spinner"></div>
    <p class="status-text" id="status">R√©veil en cours...</p>
    <div class="footer">CityGuided - Infrastructure √©co-responsable üå±</div>
  </div>
  <script>
    // URL de la Lambda de r√©veil (inject√©e par update-caddy.ts)
    const WAKE_UP_URL = '{{LAMBDA_URL}}';
    
    let attempts = 0;
    const maxAttempts = 30; // 30 * 2s = 60s max
    
    // Appeler la Lambda imm√©diatement au chargement de la page
    async function triggerWakeUp() {
      try {
        // Fire-and-forget: on n'attend pas la r√©ponse
        fetch(WAKE_UP_URL, { 
          method: 'POST',
          mode: 'no-cors', // La Lambda n'a pas besoin de CORS pour le trigger
        }).catch(() => {}); // Ignorer les erreurs
        
        console.log('Wake-up trigger sent to Lambda');
      } catch (e) {
        console.log('Could not trigger wake-up:', e);
      }
      
      // Commencer √† v√©rifier si le service est pr√™t
      checkService();
    }
    
    function checkService() {
      attempts++;
      const status = document.getElementById('status');
      status.textContent = 'R√©veil en cours... (' + attempts + '/' + maxAttempts + ')';
      
      fetch(window.location.href, { method: 'HEAD', cache: 'no-store' })
        .then(response => {
          if (response.ok) {
            status.textContent = 'Service pr√™t ! Redirection...';
            setTimeout(() => window.location.reload(), 500);
          } else if (attempts < maxAttempts) {
            setTimeout(checkService, 2000);
          } else {
            showError();
          }
        })
        .catch(() => {
          if (attempts < maxAttempts) {
            setTimeout(checkService, 2000);
          } else {
            showError();
          }
        });
    }
    
    function showError() {
      const status = document.getElementById('status');
      const spinner = document.getElementById('spinner');
      
      spinner.style.display = 'none';
      status.innerHTML = 'Le service prend plus de temps que pr√©vu...<br><a href="javascript:location.reload()" style="color:#fff;text-decoration:underline">R√©essayer</a>';
    }
    
    // Lancer le r√©veil d√®s le chargement de la page
    triggerWakeUp();
  </script>
</body>
</html>
